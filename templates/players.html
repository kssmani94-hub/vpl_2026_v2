{% extends "base.html" %}
{% block content %}
<div class="admin-container" style="max-width: 1450px; margin: 20px auto; padding: 20px; font-family: 'Segoe UI', sans-serif;">
    
    {% set total_slots = 200 %} 
    {% set current_regs = players|length %}
    {% set remaining = total_slots - current_regs %}

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: #003554; color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 20px rgba(0,53,84,0.2);">
            <p style="margin:0; font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; font-weight: 700;">Total Registrations</p>
            <p style="margin:5px 0 0; font-size: 2.2rem; font-weight: 800;">{{ current_regs }} / {{ total_slots }}</p>
        </div>
        <div style="background: #ffffff; border: 1px solid #ddd; padding: 25px; border-radius: 15px; text-align: center;">
            <p style="margin:0; font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700;">Awaiting Approval</p>
            <p style="margin:5px 0 0; font-size: 2.2rem; font-weight: 800; color: #f39c12;">
                {{ players|selectattr('status', 'equalto', 'Pending Approval')|list|length }}
            </p>
        </div>
        <div style="background: #eef6ff; border: 2px solid #00a6fb; padding: 25px; border-radius: 15px; text-align: center;">
            <p style="margin:0; font-size: 0.8rem; color: #003554; text-transform: uppercase; font-weight: 700;">Slots Remaining</p>
            <p style="margin:5px 0 0; font-size: 2.2rem; font-weight: 800; color: #00a6fb;">{{ remaining if remaining > 0 else 0 }}</p>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 15px;">
        <div style="position: relative;">
            <i class="fa fa-search" style="position: absolute; left: 15px; top: 15px; color: #94a3b8;"></i>
            <input type="text" id="adminSearch" onkeyup="searchPlayers()" placeholder="Search Name, VPL ID, or Mobile..." 
                   style="width: 350px; padding: 12px 12px 12px 45px; border-radius: 50px; border: 1px solid #e2e8f0; outline: none; font-size: 0.9rem;">
        </div>
        <div style="display: flex; gap: 12px;">
            {% if session.get('username') == 'admin' %}
                <a href="{{ url_for('manage_users') }}" style="background: #00a6fb; color: white; padding: 12px 20px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fa fa-users-cog"></i> MANAGE USERS
                </a>
            {% endif %}
            <a href="{{ url_for('activity_logs') }}" style="background: #64748b; color: white; padding: 12px 20px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;">
                <i class="fa fa-list-ul"></i> ACTIVITY LOGS
            </a>
            <a href="{{ url_for('export_players') }}" style="background: #22c55e; color: white; padding: 12px 20px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;">
                <i class="fa fa-file-excel"></i> DOWNLOAD FULL EXCEL
            </a>
        </div>
    </div>

    <div style="background: #fff; border-radius: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.05); overflow-x: auto;">
        <table id="vplTable" style="width: 100%; border-collapse: collapse; min-width: 1000px;">
            <thead>
                <tr style="background: #003554; color: white; text-align: left;">
                    <th style="padding: 18px;">VPL ID</th>
                    <th>Full Name</th>
                    <th>Mobile</th>
                    <th>Payment</th>
                    <th>Status</th>
                    <th style="text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in players %}
                <tr style="border-bottom: 1px solid #f1f5f9; transition: 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                    <td style="padding: 18px; font-weight: 800; color: #00a6fb;">{{ p.vpl_id }}</td>
                    <td style="font-weight: 600;">{{ p.full_name }}</td>
                    <td>{{ p.phone }}</td>
                    <td>
                        <span style="font-size: 0.8rem; font-weight: 600; color: #64748b;">
                            <i class="fa {% if p.payment_method == 'UPI' %}fa-mobile-alt{% else %}fa-hand-holding-usd{% endif %}" style="margin-right: 5px;"></i>
                            {{ p.payment_method }}
                        </span>
                    </td>
                    <td>
                        <span style="padding: 5px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
                            background: {% if p.status == 'Approved' %}#dcfce7; color: #15803d;{% else %}#fef9c3; color: #a16207;{% endif %}">
                            {{ p.status }}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; justify-content: center; gap: 8px;">
                            <button onclick="toggleRow('{{ p.id }}')" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; color: #475569; font-size: 0.75rem;">VIEW</button>
                            <a href="{{ url_for('edit_player', id=p.id) }}" style="background: #003554; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 0.75rem;">EDIT</a>
                            
                            <form action="{{ url_for('delete_player', id=p.id) }}" method="POST" onsubmit="return confirm('Permanently remove {{ p.full_name }}?');" style="display:inline;">
                                <button type="submit" style="background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>

                <tr id="profile-{{ p.id }}" style="display: none; background: #fafafa; border-bottom: 3px solid #00a6fb;">
                    <td colspan="6" style="padding: 30px;">
                        <div style="display: flex; gap: 40px; align-items: start; flex-wrap: wrap;">
                            <div style="display: flex; gap: 20px;">
                                <div style="text-align: center;">
                                    <label style="display:block; font-size: 0.6rem; font-weight: 900; color: #003554; margin-bottom: 5px; text-transform: uppercase;">Profile Photo</label>
                                    <img src="{{ url_for('static', filename='uploads/' + p.photo) }}" style="width: 140px; height: 180px; object-fit: cover; border-radius: 12px; border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                                </div>
                                <div style="text-align: center;">
                                    <label style="display:block; font-size: 0.6rem; font-weight: 900; color: #003554; margin-bottom: 5px; text-transform: uppercase;">UPI Screenshot</label>
                                    {% if p.payment_screenshot %}
                                        <a href="{{ url_for('static', filename='uploads/' + p.payment_screenshot) }}" target="_blank">
                                            <img src="{{ url_for('static', filename='uploads/' + p.payment_screenshot) }}" style="width: 140px; height: 180px; object-fit: cover; border-radius: 12px; border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                                        </a>
                                    {% else %}
                                        <div style="width: 140px; height: 180px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.7rem; font-weight: bold; border: 2px dashed #cbd5e1;">N/A</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div style="flex: 1; min-width: 300px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Age</label><div style="font-weight: 700;">{{ p.age }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Style</label><div style="font-weight: 700;">{{ p.style }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Prev Team</label><div style="font-weight: 700;">{{ p.prev_team }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Role</label><div style="font-weight: 700;">{{ p.role }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Jersey Name</label><div style="font-weight: 700; color: #003554;">{{ p.shirt_name }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Jersey No</label><div style="font-weight: 700;">#{{ p.shirt_number }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Size</label><div style="font-weight: 700;">{{ p.shirt_size }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase;">Sleeves</label><div style="font-weight: 700;">{{ p.sleeves }}</div></div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleRow(id) {
        let profileRow = document.getElementById('profile-' + id);
        if (profileRow.style.display === "table-row") {
            profileRow.style.display = "none";
        } else {
            document.querySelectorAll('[id^="profile-"]').forEach(row => row.style.display = 'none');
            profileRow.style.display = "table-row";
        }
    }

    function searchPlayers() {
        let filter = document.getElementById("adminSearch").value.toUpperCase();
        let mainRows = document.querySelectorAll("#vplTable tbody tr:not([id^='profile-'])");
        mainRows.forEach(row => {
            let text = row.innerText.toUpperCase();
            if (text.indexOf(filter) > -1) {
                row.style.display = "";
            } else {
                row.style.display = "none";
                let nextRow = row.nextElementSibling;
                if(nextRow && nextRow.id.startsWith("profile-")) {
                    nextRow.style.display = "none";
                }
            }
        });
    }
</script>
{% endblock %}